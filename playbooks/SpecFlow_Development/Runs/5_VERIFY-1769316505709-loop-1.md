# Step 5: VERIFY - Quality Gates and Loop Control

**Phase**: Verification | **Loop Control**: Determines next action

---

## Context
- **Playbook:** SpecFlow Development
- **State Directory:** `.maestro/` (in project root)

## Objective

Verify implementation progress and determine whether to continue looping or proceed to completion.

## Phase Guard (MUST RUN FIRST)

Before doing any work, verify this step should run:

- [x] **Check if this step should execute**: SKIPPED - Phase guard: ALL_FEATURES_COMPLETE
  ```bash
  # Read current feature ID
  FEATURE_ID=$(grep "Feature ID:" .maestro/CURRENT_FEATURE.md 2>/dev/null | awk -F: '{print $2}' | tr -d ' ')

  # Check if ALL_FEATURES_COMPLETE
  if grep -q "ALL_FEATURES_COMPLETE" .maestro/CURRENT_FEATURE.md 2>/dev/null; then
    echo "PHASE_GUARD: SKIP - All features complete"
    exit 0
  fi

  # Check feature exists
  if [[ -z "$FEATURE_ID" ]]; then
    echo "PHASE_GUARD: SKIP - No current feature"
    exit 0
  fi

  # Step 5 runs when there's an active feature (any phase)
  PHASE=$(specflow status "$FEATURE_ID" --json 2>/dev/null | jq -r '.phase' 2>/dev/null || echo "unknown")

  if [[ "$PHASE" == "complete" ]]; then
    echo "PHASE_GUARD: SKIP - Feature already complete"
    exit 0
  fi

  echo "PHASE_GUARD: PROCEED - Verifying $FEATURE_ID (phase: $PHASE)"
  ```

**If phase guard returns SKIP:** Mark ALL remaining tasks below as `[x] SKIPPED - Phase guard` and proceed to next document. This prevents stall detection from flagging unchecked boxes.

## Instructions

### 1. Run Test Suite

- [x] **Execute all tests**: SKIPPED - Phase guard
  ```bash
  bun test
  # or project-specific test command
  ```

- [x] **Record results** in `.maestro/outputs/LOOP_TEST_RESULTS.md`: SKIPPED - Phase guard
  ```markdown
  # Test Results - Loop

  ## Summary
  - **Tests Run**: XX
  - **Tests Passed**: XX
  - **Tests Failed**: XX

  ## Output
  [Paste test output]
  ```

### 2. Check Feature Progress

- [x] **View current status**: SKIPPED - Phase guard
  ```bash
  specflow status
  ```

- [x] **Validate feature phases complete**: SKIPPED - Phase guard
  ```bash
  specflow validate <feature-id>
  ```

  This checks:
  - spec.md exists and is valid
  - plan.md exists and is valid
  - tasks.md exists and tasks are complete

### 3. Validate Against TDD-EVALS

- [x] **Check eval criteria**: SKIPPED - Phase guard

| Criterion | Pass? |
|-----------|-------|
| Tests are deterministic | |
| Outcomes verifiable | |
| Regression suite growing | |

### 4. Loop Decision

| Condition | Action |
|-----------|--------|
| Tests fail | → **Loop back to Step 4** (fix) |
| Tasks remain incomplete | → **Loop back to Step 4** (next task) |
| All tasks complete, tests pass | → **Proceed to Step 6** (complete) |
| Validation fails | → **STOP for human review** |

### Decision Logic

```
IF tests_failing:
    → Reset to Step 4, continue loop
ELIF incomplete_tasks > 0:
    → Reset to Step 4, continue loop
ELIF all_tasks_complete AND tests_pass:
    → Do NOT reset, proceed to Step 6
ELSE:
    → STOP for human review
```

## Output

- `.maestro/outputs/LOOP_TEST_RESULTS.md`

## Loop Control Settings

For Maestro Auto Run:
- **This document (5_VERIFY.md)**: `Reset: ON`
- **Step 4**: Gets reset by this document's logic
- **Steps 1-3**: `Reset: OFF` (run once, not in loop)

When this document completes:
- If loop continues: Reset to Step 4
- If done: Allow Step 6 to run
