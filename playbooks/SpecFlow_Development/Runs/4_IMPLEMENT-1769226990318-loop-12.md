# Step 4: IMPLEMENT - TDD Execution

**Phase**: Implementation | **Loop**: Repeats until all tasks complete

---

## Context
- **Playbook:** SpecFlow Development
- **State Directory:** `.maestro/` (in project root)

## Objective

Implement the next task using TDD (Test-Driven Development).

## Prerequisites

- Tasks approved (tasks.md exists and human approved)
- Feature phase is "tasks" or "implement"
- **State directory exists** (create if needed):
  ```bash
  mkdir -p .maestro/outputs
  ```

## Instructions

### 1. Get Implementation Context

- [x] **Get next task context**:
  ```bash
  specflow implement
  ```

  Or for a specific feature:
  ```bash
  specflow implement --feature <feature-id>
  ```

  This outputs:
  - Feature spec
  - Technical plan
  - Tasks with current progress
  - Implementation prompt for AI

**Note:** Initially showed F-016 in "plan" phase. Ran `specflow tasks F-016` to generate tasks.md with 10 implementation tasks across 4 phases.

### 2. TDD Cycle: RED

- [x] **Write failing test first**:
  - Create test file if doesn't exist
  - Write test for the current task's acceptance criteria
  - Run tests to confirm failure (RED state)

- [x] **Record test creation** in `.maestro/outputs/LOOP_PROGRESS.md`:
  ```markdown
  ## Task: [task name]
  ### Tests Written
  * test_xxx: [description]
  ```

**Tests Created:** `hooks/SkillInvocationEnforcement.hook.test.ts` with 35 tests covering:
- validateExtendYaml (schema validation)
- getCustomizationPath (path resolution)
- loadExtendYaml (YAML parsing)
- generateLoadingInstructions (instruction format)
- Tool filtering (Skill tool only)
- Error handling (fail-open behavior)
- EXTEND.yaml scenarios (enabled/disabled)
- Performance tests (< 500ms bounds)

### 3. TDD Cycle: GREEN

- [x] **Implement minimal code** to make tests pass:
  - Focus only on current task
  - Don't over-engineer
  - Follow the plan.md architecture

- [x] **Run tests** to confirm passing (GREEN state):
  ```bash
  bun test
  # or project-specific test command
  ```

**Implementation:** `hooks/SkillInvocationEnforcement.hook.ts` with:
- Schema validation (validateExtendYaml)
- Path resolution with sanitization (getCustomizationPath)
- YAML parsing with fail-open error handling (loadExtendYaml)
- Instruction generation in system-reminder format (generateLoadingInstructions)
- Main hook logic with 100ms stdin timeout

**Test Results:** 35 pass, 0 fail (98 expect() calls)

### 4. TDD Cycle: REFACTOR (if needed)

- [x] **Clean up code** while keeping tests green:
  - Remove duplication
  - Improve naming
  - Keep it simple

**Refactoring:** Code followed existing hook patterns from ToolUseInstrumentation.hook.ts. No major refactoring needed - implementation was clean from the start.

### 5. Update Progress

- [x] **Update progress file**:
  ```markdown
  ### Implementation
  - Files created: [list]
  - Files modified: [list]
  - Tests passing: [count]
  ```

**Files Created:**
- `hooks/SkillInvocationEnforcement.hook.ts` - Main hook implementation
- `hooks/SkillInvocationEnforcement.hook.test.ts` - Comprehensive test suite

**Files Modified:**
- `settings.json` - Added PreToolUse hook entry for "Skill" matcher
- `.specify/specs/f-016-skill-invocation-enforcement/tasks.md` - Marked all tasks complete
- `.specify/specs/f-016-skill-invocation-enforcement/spec.md` - Updated status to "implement"
- `.maestro/CURRENT_FEATURE.md` - Updated phase and added implementation notes

**Tests Passing:** 152 total (35 new + 117 existing)

## Output

- New/modified source files
- New/modified test files
- `.maestro/outputs/LOOP_PROGRESS.md` updated

## Next

â†’ Proceed to Step 5 (VERIFY) to check progress and loop control
