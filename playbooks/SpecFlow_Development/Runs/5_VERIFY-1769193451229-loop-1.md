# Step 5: VERIFY - Quality Gates and Loop Control

**Phase**: Verification | **Loop Control**: Determines next action

---

## Context
- **Playbook:** SpecFlow Development
- **State Directory:** `.maestro/` (in project root)

## Objective

Verify implementation progress and determine whether to continue looping or proceed to completion.

## Instructions

### 1. Run Test Suite

- [x] **Execute all tests**:
  ```bash
  bun test
  # or project-specific test command
  ```
  **Result:** 282 tests passed, 0 failed (1 skipped due to environment permission)

- [x] **Record results** in `.maestro/outputs/LOOP_TEST_RESULTS.md`:
  ```markdown
  # Test Results - Loop

  ## Summary
  - **Tests Run**: 282
  - **Tests Passed**: 282
  - **Tests Failed**: 0

  ## Output
  [Paste test output]
  ```
  **Result:** Created at `.maestro/outputs/LOOP_TEST_RESULTS.md`

### 2. Check Feature Progress

- [x] **View current status**:
  ```bash
  specflow status
  ```
  **Result:** 16 features | 6 complete | 0 in progress | 10 pending | Progress: 38%
  F-6 is in phase "tasks" with status "pending"

- [x] **Validate feature phases complete**:
  ```bash
  specflow validate F-6
  ```
  **Result:**
  - ✓ spec.md exists (17406 bytes)
  - ✓ plan.md exists (20312 bytes)
  - ✓ tasks.md exists (12418 bytes)
  - ✗ docs.md missing (required for completion)
  - ⚠ Warning: docs.md not yet created - required before 'specflow complete'

  This checks:
  - spec.md exists and is valid
  - plan.md exists and is valid
  - tasks.md exists and tasks are complete

### 3. Validate Against TDD-EVALS

- [x] **Check eval criteria**:

| Criterion | Pass? |
|-----------|-------|
| Tests are deterministic | ✓ Yes - 282 tests pass consistently |
| Outcomes verifiable | ✓ Yes - event emission tested with unit tests |
| Regression suite growing | ✓ Yes - added 10 new tests for countToolCalls |

### 4. Loop Decision

| Condition | Action |
|-----------|--------|
| Tests fail | → **Loop back to Step 4** (fix) |
| Tasks remain incomplete | → **Loop back to Step 4** (next task) |
| All tasks complete, tests pass | → **Proceed to Step 6** (complete) |
| Validation fails | → **STOP for human review** |

### Decision Logic

```
IF tests_failing:
    → Reset to Step 4, continue loop
ELIF incomplete_tasks > 0:
    → Reset to Step 4, continue loop
ELIF all_tasks_complete AND tests_pass:
    → Do NOT reset, proceed to Step 6
ELSE:
    → STOP for human review
```

## Output

- `.maestro/outputs/LOOP_TEST_RESULTS.md`

## Loop Control Settings

For Maestro Auto Run:
- **This document (5_VERIFY.md)**: `Reset: ON`
- **Step 4**: Gets reset by this document's logic
- **Steps 1-3**: `Reset: OFF` (run once, not in loop)

When this document completes:
- If loop continues: Reset to Step 4
- If done: Allow Step 6 to run

---

## Verification Results (Loop 1)

### Summary
- **Tests:** 282 pass, 0 fail ✓
- **F-6 Implementation:** Code complete (T-1.1, T-1.2, T-1.3 implemented)
- **SpecFlow Validation:** BLOCKED - missing docs.md and verify.md

### Implementation Status
The core F-6 implementation is complete:
- `countToolCalls()` helper function added to `hooks/StopOrchestrator.hook.ts`
- Event library import added
- Session end event emission block added
- 10 unit tests added in `hooks/__tests__/StopOrchestrator.test.ts`

### Outstanding Work
To satisfy `specflow complete F-6`:
1. Create `.specify/specs/f-6-sessionstop-hook-instrumentation/docs.md` - document changes
2. Create `.specify/specs/f-6-sessionstop-hook-instrumentation/verify.md` - end-to-end verification

### Decision: **→ Loop back to Step 4 (incomplete tasks)**

The core implementation is done but specflow completion artifacts are missing.
