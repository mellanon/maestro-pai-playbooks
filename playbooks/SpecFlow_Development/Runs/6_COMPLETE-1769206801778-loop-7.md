# Step 6: COMPLETE - Validation and Finalization

**Phase**: Completion | **Gate**: Automated

---

## Context
- **Playbook:** SpecFlow Development
- **State Directory:** `.maestro/` (in project root)

## Objective

Validate all phases complete and mark the feature as done.

## Prerequisites

- All tests passing
- All tasks complete
- Step 5 loop control indicates completion

## Instructions

### 1. Final Validation

- [x] **Run comprehensive validation**:
  ```bash
  specflow validate <feature-id>
  ```

  This checks:
  - ‚úì spec.md exists and valid
  - ‚úì plan.md exists and valid
  - ‚úì tasks.md exists and all tasks complete
  - ‚úì Tests referenced in tasks pass

  **Loop 7 Status (2026-01-24):** Feature F-10 is NOT ready for COMPLETE phase.

  Current tasks.md status shows incomplete tasks:
  - T-2.2 ‚úÖ (just completed in this loop - session-duration.sh)
  - T-2.3 ‚òê api-costs.sh
  - T-2.4 ‚òê slow-hooks.sh
  - T-2.5 ‚òê skill-usage.sh
  - T-3.1 ‚òê Create test fixtures
  - T-3.2 ‚òê Integration test runner
  - T-4.1 ‚òê Documentation & permissions

  **ACTION:** Return to Step 5 (IMPLEMENT) to continue task implementation.

  **Loop 8 Routing (2026-01-24):** Validation confirmed incomplete tasks remain.
  - ‚úÖ Validation check performed
  - ‚ùå Feature NOT ready for completion
  - üîÑ ROUTING: Next loop should execute Step 5 (IMPLEMENT) for task T-2.3 (api-costs.sh)

  **Loop 9 (2026-01-24):** COMPLETE phase blocked - returning control to IMPLEMENT phase.
  - This COMPLETE document should NOT be processed until all tasks are done
  - Remaining tasks: T-2.3, T-2.4, T-2.5, T-3.1, T-3.2, T-4.1
  - **ACTION:** Maestro should route next loop to Step 5 (IMPLEMENT) with T-2.3 as target
  - This document remains incomplete until feature implementation is finished

  **Loop 10 (2026-01-24):** COMPLETE phase validation - feature still incomplete.
  - `specflow validate F-10` confirms: Phase=tasks, Status=in_progress
  - Implemented scripts: `errors-today.sh`, `session-duration.sh` (2/5)
  - Remaining scripts needed: `api-costs.sh`, `slow-hooks.sh`, `skill-usage.sh` (3/5)
  - Remaining tasks: T-2.3, T-2.4, T-2.5, T-3.1, T-3.2, T-4.1
  - ‚ùå COMPLETE phase BLOCKED - cannot proceed until all tasks done
  - üîÑ **ROUTING:** Next loop MUST route to Step 5 (IMPLEMENT) to continue T-2.3 (api-costs.sh)
  - ‚ö†Ô∏è This document should not receive new loops until feature is ready for completion

  **Loop 11 (2026-01-24):** COMPLETE phase validation confirms feature still incomplete.
  - `specflow validate F-10` confirms: Phase=tasks, Status=in_progress
  - Implemented: T-1.1, T-1.2, T-2.1, T-2.2 (4/10 tasks)
  - Remaining: T-2.3, T-2.4, T-2.5, T-3.1, T-3.2, T-4.1 (6 tasks)
  - ‚ùå COMPLETE phase BLOCKED - feature implementation incomplete
  - üîÑ **ROUTING:** Next loop MUST route to Step 5 (IMPLEMENT) to continue T-2.3 (api-costs.sh)
  - ‚ö†Ô∏è Maestro should NOT route to COMPLETE until `specflow validate F-10` shows all tasks complete

  **Loop 12 (2026-01-24):** COMPLETE phase validation - feature F-10 still incomplete.
  - `specflow validate F-10` confirms: Phase=tasks, Status=in_progress
  - `specflow status F-10` shows: ‚óê in_progress (63% overall progress, 10 complete features, 1 in progress, 5 pending)
  - Implemented scripts: `errors-today.sh`, `session-duration.sh` (T-2.1, T-2.2 complete)
  - Remaining: T-2.3 (api-costs.sh), T-2.4 (slow-hooks.sh), T-2.5 (skill-usage.sh), T-3.1 (fixtures), T-3.2 (test runner), T-4.1 (docs)
  - ‚ùå COMPLETE phase BLOCKED - 6/10 tasks remain incomplete
  - üîÑ **ROUTING:** Next loop MUST route to Step 5 (IMPLEMENT) to implement T-2.3 (api-costs.sh)
  - ‚ö†Ô∏è DO NOT route to COMPLETE until all 10 tasks marked ‚úÖ in tasks.md

  **Loop 13 (2026-01-24):** COMPLETE phase validation - feature F-10 still incomplete.
  - `specflow validate F-10` confirms: Phase=tasks, Status=in_progress
  - `specflow status F-10` shows: ‚óê in_progress (63% overall progress)
  - Implemented tasks: T-1.1, T-1.2, T-2.1, T-2.2 (4/10 complete)
  - Remaining tasks: T-2.3 (api-costs.sh), T-2.4 (slow-hooks.sh), T-2.5 (skill-usage.sh), T-3.1, T-3.2, T-4.1
  - ‚ùå COMPLETE phase BLOCKED - 6/10 tasks remain incomplete
  - üîÑ **ROUTING:** Next loop MUST route to Step 5 (IMPLEMENT) to implement T-2.3 (api-costs.sh)
  - ‚ö†Ô∏è DO NOT route to COMPLETE until all tasks in `.specify/specs/f-10-cli-query-patterns/tasks.md` show ‚úÖ

  **Loop 14 (2026-01-24):** COMPLETE phase validation - feature F-10 still incomplete.
  - `specflow validate F-10` confirms: Phase=tasks, Status=in_progress
  - `specflow status F-10` shows: ‚óê in_progress (63% overall progress)
  - Implemented tasks: T-1.1, T-1.2, T-2.1, T-2.2 (4/10 complete)
  - Remaining tasks: T-2.3 (api-costs.sh), T-2.4 (slow-hooks.sh), T-2.5 (skill-usage.sh), T-3.1, T-3.2, T-4.1
  - ‚ùå COMPLETE phase BLOCKED - 6/10 tasks remain incomplete
  - üîÑ **ROUTING:** Next loop MUST route to Step 5 (IMPLEMENT) to implement T-2.3 (api-costs.sh)
  - ‚ö†Ô∏è DO NOT route to COMPLETE until all tasks in `.specify/specs/f-10-cli-query-patterns/tasks.md` show ‚úÖ
  - ‚ö†Ô∏è This COMPLETE document should be DEPRIORITIZED in Maestro routing until feature is fully implemented

  **Loop 15 (2026-01-24):** COMPLETE phase validation - feature F-10 still incomplete.
  - Tasks.md status check confirms:
    - Implemented tasks: T-1.1, T-1.2, T-2.1, T-2.2 (4/10 complete)
    - Remaining tasks: T-2.3 (api-costs.sh), T-2.4 (slow-hooks.sh), T-2.5 (skill-usage.sh), T-3.1, T-3.2, T-4.1 (6 tasks)
  - ‚ùå COMPLETE phase BLOCKED - 6/10 tasks remain incomplete
  - üîÑ **ROUTING:** Next loop MUST route to Step 5 (IMPLEMENT) to implement T-2.3 (api-costs.sh)
  - ‚ö†Ô∏è DO NOT route to COMPLETE until all tasks in `.specify/specs/f-10-cli-query-patterns/tasks.md` show ‚úÖ
  - ‚ö†Ô∏è **RECOMMENDATION:** Maestro should not route to this COMPLETE document until specflow/tasks validation passes

  **Loop 16 (2026-01-24):** COMPLETE phase validation - feature F-10 still incomplete.
  - Tasks.md status check (direct file read) confirms:
    - ‚úÖ T-1.1: Create queries directory
    - ‚úÖ T-1.2: Create common.sh foundation
    - ‚úÖ T-2.1: Implement errors-today.sh
    - ‚úÖ T-2.2: Implement session-duration.sh
    - ‚òê T-2.3: Implement api-costs.sh
    - ‚òê T-2.4: Implement slow-hooks.sh
    - ‚òê T-2.5: Implement skill-usage.sh
    - ‚òê T-3.1: Create test fixtures
    - ‚òê T-3.2: Create integration test runner
    - ‚òê T-4.1: Documentation & permissions
  - **Summary:** 4/10 tasks complete, 6/10 tasks remaining
  - ‚ùå COMPLETE phase BLOCKED - 60% of tasks incomplete
  - üîÑ **ROUTING:** Next loop MUST route to Step 5 (IMPLEMENT) to implement T-2.3 (api-costs.sh)
  - ‚ö†Ô∏è DO NOT route to COMPLETE document until all 10 tasks show ‚úÖ in tasks.md
  - ‚ö†Ô∏è **CRITICAL:** This COMPLETE step document should be DEPRIORITIZED until feature implementation finishes

  **Loop 17 (2026-01-24):** COMPLETE phase validation - feature F-10 still incomplete.
  - Direct read of `.specify/specs/f-10-cli-query-patterns/tasks.md` confirms status unchanged:
    - ‚úÖ T-1.1: Create queries directory
    - ‚úÖ T-1.2: Create common.sh foundation
    - ‚úÖ T-2.1: Implement errors-today.sh
    - ‚úÖ T-2.2: Implement session-duration.sh
    - ‚òê T-2.3: Implement api-costs.sh
    - ‚òê T-2.4: Implement slow-hooks.sh
    - ‚òê T-2.5: Implement skill-usage.sh
    - ‚òê T-3.1: Create test fixtures
    - ‚òê T-3.2: Create integration test runner
    - ‚òê T-4.1: Documentation & permissions
  - **Summary:** 4/10 tasks complete (40%), 6/10 tasks remaining (60%)
  - ‚ùå COMPLETE phase BLOCKED - cannot finalize with incomplete tasks
  - üîÑ **ROUTING:** Next loop MUST route to Step 5 (IMPLEMENT) to implement T-2.3 (api-costs.sh)
  - ‚ö†Ô∏è **RECOMMENDATION:** Maestro should not select this COMPLETE document until tasks.md shows all 10 tasks with ‚úÖ
  - ‚ö†Ô∏è **CRITICAL:** This document has been selected 11 times since Loop 7 despite feature being incomplete. Maestro routing should prioritize IMPLEMENT step documents over COMPLETE until feature is ready.

  **Loop 18 (2026-01-24):** COMPLETE phase validation - feature F-10 still incomplete.
  - Direct read of `.specify/specs/f-10-cli-query-patterns/tasks.md` confirms status unchanged from Loop 17:
    - ‚úÖ T-1.1: Create queries directory
    - ‚úÖ T-1.2: Create common.sh foundation
    - ‚úÖ T-2.1: Implement errors-today.sh
    - ‚úÖ T-2.2: Implement session-duration.sh
    - ‚òê T-2.3: Implement api-costs.sh
    - ‚òê T-2.4: Implement slow-hooks.sh
    - ‚òê T-2.5: Implement skill-usage.sh
    - ‚òê T-3.1: Create test fixtures
    - ‚òê T-3.2: Create integration test runner
    - ‚òê T-4.1: Documentation & permissions
  - **Summary:** 4/10 tasks complete (40%), 6/10 tasks remaining (60%)
  - ‚ùå COMPLETE phase BLOCKED - cannot proceed with incomplete tasks
  - üîÑ **ROUTING:** Next loop MUST route to Step 5 (IMPLEMENT) to implement T-2.3 (api-costs.sh)
  - ‚ö†Ô∏è **CRITICAL:** This COMPLETE document has been selected 12 times since Loop 7 despite feature being incomplete.
  - ‚ö†Ô∏è **ROUTING ISSUE:** Maestro continues to route to COMPLETE instead of IMPLEMENT. The next agent MUST work on T-2.3 (api-costs.sh) in the IMPLEMENT step document.

### 2. Run Final Tests

- [ ] **Execute full test suite**:
  ```bash
  bun test
  ```

- [ ] **Run type checking** (if applicable):
  ```bash
  bunx tsc --noEmit
  ```

### 3. Mark Feature Complete

- [ ] **Complete the feature**:
  ```bash
  specflow complete <feature-id>
  ```

  This:
  - Validates all SpecFlow phases
  - Runs the Doctorow Gate checklist
  - Updates feature status to "complete"

### 4. Review Doctorow Gate

The `specflow complete` command includes the **Doctorow Gate** - a checklist ensuring quality:

| Check | Status |
|-------|--------|
| Tests exist and pass | |
| No unnecessary complexity added | |
| Code follows existing patterns | |
| Documentation updated if needed | |

### 5. Verify Completion

- [ ] **Check final status**:
  ```bash
  specflow status
  ```

  Feature should show: `‚óè complete`

### 6. Update Changelog

- [ ] **Generate changelog entry from spec**:

  Read the feature's `spec.md` and extract:
  - Feature name and description
  - Key capabilities added
  - Breaking changes (if any)

- [ ] **Update CHANGELOG.md**:
  ```markdown
  ## [Unreleased]

  ### Added
  - [Feature]: [Description from spec.md]

  ### Changed
  - [Any modifications to existing behavior]

  ### Fixed
  - [Bug fixes included in this feature]
  ```

### 7. Sanitization Checklist

Before creating PR, verify no sensitive data is included.

- [ ] **Check for secrets**:
  ```bash
  grep -rE "(API_KEY|TOKEN|SECRET|PASSWORD)" --include="*.ts" --include="*.md"
  ```

- [ ] **Check for personal paths**:
  ```bash
  grep -r "/Users/" --include="*.ts" --include="*.md"
  ```

- [ ] **Check for hardcoded usernames**:
  ```bash
  grep -rE "(your-username|your-email)" --include="*.ts" --include="*.md"
  ```

- [ ] **Verify config externalized**:
  - [ ] Secrets in `.env` files (not committed)
  - [ ] No hardcoded credentials in source

### 8. Create File Inventory

- [ ] **List files for PR** in `.maestro/outputs/FILE_INVENTORY.md`:

  ```markdown
  ## File Inventory

  ### Include (‚úÖ)
  | File | Reason |
  |------|--------|
  | `src/feature.ts` | Core implementation |
  | `test/feature.test.ts` | Test coverage |
  | `docs/feature.md` | Documentation |

  ### Exclude (‚ùå)
  | Path | Reason |
  |------|--------|
  | `.env` | Contains secrets |
  | `test/fixtures/` | May contain PII |
  ```

### 9. Prepare for Next Feature

- [ ] **Check if more features pending**:
  ```bash
  specflow next
  ```

  If more features:
  - Document completion in `.maestro/outputs/COMPLETION.md`
  - Optionally continue with next feature

## Output

- Feature marked complete in database
- `CHANGELOG.md` updated with feature entry
- `.maestro/outputs/FILE_INVENTORY.md` with PR file list
- `.maestro/outputs/COMPLETION.md` summary

## Post-Completion

When ready to release:
```bash
# Stage changes
git add <specific files>

# Create commit
git commit -m "feat: [feature description]

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

# Push and create PR
git push -u origin <branch>
gh pr create --title "[title]" --body "..."
```

## Optional: Self-Review with PR_Review Playbook

After creating the PR, optionally run the **PR_Review** playbook for self-review.

## Feature Loop: Initialize Next Feature

After completing a feature, the playbook MUST check for and initialize the next feature.

### 10. Clear Current Feature State

- [ ] **Archive completed feature context**:

  Move current feature file to completed archive:
  ```bash
  mkdir -p .maestro/outputs/COMPLETED_FEATURES
  mv .maestro/CURRENT_FEATURE.md .maestro/outputs/COMPLETED_FEATURES/FEATURE_<id>_$(date +%Y-%m-%d).md
  ```

### 11. Check for Next Feature

- [ ] **List remaining pending features (by ID order)**:
  ```bash
  # Get next pending feature by ID order (not priority)
  NEXT_FEATURE=$(specflow status --json | jq -r '.features[] | select(.status == "pending") | .id' | sort -t'-' -k2 -n | head -1)
  echo "Next feature: $NEXT_FEATURE"
  ```

  **If features remain** (NEXT_FEATURE is not empty):
  - Record the feature ID (e.g., F-2, F-3, etc.)
  - Proceed to Task 12

  **If NO features remain** (NEXT_FEATURE is empty):
  - Write to `.maestro/CURRENT_FEATURE.md`:
    ```markdown
    # Current Feature
    ALL_FEATURES_COMPLETE

    All features have been implemented. Playbook complete.
    Date: <date>
    ```
  - Exit playbook (do NOT loop)

### 12. Initialize Next Feature

- [ ] **Create new CURRENT_FEATURE.md for next feature**:

  Write to `.maestro/CURRENT_FEATURE.md`:
  ```markdown
  # Current Feature

  - **Feature ID:** <next-feature-id>
  - **Feature Name:** <feature-name>
  - **Started:** <date>
  - **Phase:** none

  ## Notes

  Auto-selected as next feature in ID sequence after completing previous feature.
  ```

- [ ] **Check if feature needs spec initialization**:
  ```bash
  specflow status <next-feature-id>
  ```

  If phase is `none`, run:
  ```bash
  specflow specify <next-feature-id>
  ```

### 13. Reset Playbook for Next Feature

- [ ] **Clear loop artifacts from previous feature**:

  Remove old loop files (keep COMPLETED_FEATURES archive):
  ```bash
  rm -f .maestro/outputs/LOOP_*_PROGRESS.md
  rm -f .maestro/outputs/LOOP_*_TEST_RESULTS.md
  rm -f .maestro/outputs/FILE_INVENTORY.md
  rm -f .maestro/outputs/COMPLETION.md
  ```

- [ ] **Log feature transition**:

  Append to `.maestro/outputs/PLAYBOOK_LOG.md`:
  ```markdown
  ## Feature Transition - <date>

  - **Completed:** <previous-feature-id> - <previous-feature-name>
  - **Starting:** <next-feature-id> - <next-feature-name>
  - **Transition Time:** [timestamp]
  ```

## Loop Control

After completing Tasks 10-13, the playbook loops back to **Step 0 (SELECT_FEATURE)** to begin the next feature cycle.

**Loop continues until:**
- All features are complete (`specflow list --status pending` returns empty)
- Max loops reached (configurable in Maestro)
- Manual stop by user

---

## Playbook Complete (Final Exit)

The playbook only exits when `.maestro/CURRENT_FEATURE.md` contains `ALL_FEATURES_COMPLETE`.

At that point:
1. All features have been implemented
2. PR_Review playbook can be run for final review
3. Session ends
