# Step 5: VERIFY - Quality Gates and Loop Control

**Phase**: Verification | **Loop Control**: Determines next action

---

## Context
- **Playbook:** SpecFlow Development
- **State Directory:** `.maestro/` (in project root)

## Objective

Verify implementation progress and determine whether to continue looping or proceed to completion.

## Instructions

### 1. Run Test Suite

- [x] **Execute all tests**:
  ```bash
  bun test
  # or project-specific test command
  ```

  **Result (Loop 6):** 283 tests passed, 0 failed, 1054 expect() calls in 370ms

- [x] **Record results** in `.maestro/outputs/LOOP_TEST_RESULTS.md`:
  ```markdown
  # Test Results - Loop

  ## Summary
  - **Tests Run**: XX
  - **Tests Passed**: XX
  - **Tests Failed**: XX

  ## Output
  [Paste test output]
  ```

  **Result:** Test results recorded in `.maestro/outputs/LOOP_TEST_RESULTS.md`

### 2. Check Feature Progress

- [x] **View current status**:
  ```bash
  specflow status
  ```

  **Result:** 15 features | 4 complete | F-5 in TASKS phase (pending)

- [x] **Validate feature phases complete**:
  ```bash
  specflow validate <feature-id>
  ```

  **Result (F-5):**
  - ✓ spec.md 9755 bytes
  - ✓ plan.md 11945 bytes
  - ✓ tasks.md 7507 bytes
  - ⚠ docs.md not yet created (required before `specflow complete`)

  This checks:
  - spec.md exists and is valid
  - plan.md exists and is valid
  - tasks.md exists and tasks are complete

### 3. Validate Against TDD-EVALS

- [x] **Check eval criteria**:

| Criterion | Pass? |
|-----------|-------|
| Tests are deterministic | ✅ Yes - 283 tests pass consistently |
| Outcomes verifiable | ✅ Yes - JSONL output verified in integration tests |
| Regression suite growing | ✅ Yes - Added 20 new tests for F-5 SessionStart |

### 4. Loop Decision

| Condition | Action |
|-----------|--------|
| Tests fail | → **Loop back to Step 4** (fix) |
| Tasks remain incomplete | → **Loop back to Step 4** (next task) |
| All tasks complete, tests pass | → **Proceed to Step 6** (complete) |
| Validation fails | → **STOP for human review** |

### Decision Logic

```
IF tests_failing:
    → Reset to Step 4, continue loop
ELIF incomplete_tasks > 0:
    → Reset to Step 4, continue loop
ELIF all_tasks_complete AND tests_pass:
    → Do NOT reset, proceed to Step 6
ELSE:
    → STOP for human review
```

## Output

- `.maestro/outputs/LOOP_TEST_RESULTS.md`

## Loop Control Settings

For Maestro Auto Run:
- **This document (5_VERIFY.md)**: `Reset: ON`
- **Step 4**: Gets reset by this document's logic
- **Steps 1-3**: `Reset: OFF` (run once, not in loop)

When this document completes:
- If loop continues: Reset to Step 4
- If done: Allow Step 6 to run

---

## Loop 6 Decision

**Analysis (2026-01-24):**
- ✅ All 283 tests passing (0 failures)
- ✅ F-5 implementation complete in `hooks/LoadContext.hook.ts`
- ✅ Unit tests complete (20 tests in `hooks/LoadContext.hook.test.ts`)
- ✅ TDD-EVALS criteria met
- ⚠️ docs.md required before `specflow complete F-5`

**Decision:** → **Proceed to Step 6** (complete)

All implementation tasks for F-5 are complete and verified. The docs.md file is required but that's part of the completion phase (Step 6), not implementation.

**Files Modified:**
- `hooks/LoadContext.hook.ts` - Added session.start event emission
- `hooks/LoadContext.hook.test.ts` - Added 20 comprehensive tests

**Key Implementation Details:**
1. Session.start event emitted after context loads successfully
2. Event includes model name (from ANTHROPIC_MODEL/CLAUDE_MODEL env vars)
3. Event includes working_dir (from process.cwd())
4. Event includes unique session_id (UUID v4)
5. Subagent sessions skip event emission (early exit)
6. Fire-and-forget pattern with try-catch wrapper
