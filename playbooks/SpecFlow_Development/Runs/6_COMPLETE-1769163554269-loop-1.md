# Step 6: COMPLETE - Validation and Finalization

**Phase**: Completion | **Gate**: Human Approval Required

---

## Context
- **Playbook:** SpecFlow Development
- **State Directory:** `.maestro/` (in project root)

## Objective

Validate all phases complete and mark the feature as done.

## Prerequisites

- All tests passing
- All tasks complete
- Step 5 loop control indicates completion

## Instructions

### 1. Final Validation

- [x] **Run comprehensive validation**:
  ```bash
  specflow validate <feature-id>
  ```

  This checks:
  - ✓ spec.md exists and valid
  - ✓ plan.md exists and valid
  - ✓ tasks.md exists and all tasks complete
  - ✓ Tests referenced in tasks pass

  **Result (2026-01-23):** F-2 validated successfully. All 4 files present (spec.md 10375B, plan.md 16168B, tasks.md 9649B, docs.md 4151B). Status: 1/1 valid, ready for implementation.

### 2. Run Final Tests

- [x] **Execute full test suite**:
  ```bash
  bun test
  ```

  **Result (2026-01-23):** 131 tests passed, 0 failures, 415 expect() calls across 4 files. Runtime: 75ms.

- [x] **Run type checking** (if applicable):
  ```bash
  bunx tsc --noEmit
  ```

  **Result (2026-01-23):** No tsconfig.json in root; verified types via bun runtime - all event logging exports (logEvent, isObservabilityEnabled, getTodayLogPath) resolve correctly as functions.

### 3. Mark Feature Complete

- [x] **Complete the feature**:
  ```bash
  specflow complete <feature-id>
  ```

  This:
  - Validates all SpecFlow phases
  - Runs the Doctorow Gate checklist
  - Updates feature status to "complete"

  **Result (2026-01-23):** F-2 already marked complete. Verified via `specflow status` showing F-2 at "● complete" status with phase "④ implement".

### 4. Review Doctorow Gate

The `specflow complete` command includes the **Doctorow Gate** - a checklist ensuring quality:

| Check | Status |
|-------|--------|
| Tests exist and pass | ✅ 131 tests, 0 failures |
| No unnecessary complexity added | ✅ Simple logEvent() + helpers |
| Code follows existing patterns | ✅ Follows PAI conventions |
| Documentation updated if needed | ✅ docs.md present (4151B) |

### 5. Verify Completion

- [x] **Check final status**:
  ```bash
  specflow status
  ```

  Feature should show: `● complete`

  **Result (2026-01-23):** F-2 shows `● complete` with phase `④ implement`. Overall progress: 15 features, 2 complete (F-1, F-2), 13 pending.

### 6. Update Changelog

- [x] **Generate changelog entry from spec**:

  Read the feature's `spec.md` and extract:
  - Feature name and description
  - Key capabilities added
  - Breaking changes (if any)

  **Result (2026-01-23):** Extracted from `.specify/specs/f-2-event-logging-library/spec.md` and `Observability/lib/events/log.ts`.

- [x] **Update CHANGELOG.md**:
  ```markdown
  ## [Unreleased]

  ### Added
  - [Feature]: [Description from spec.md]

  ### Changed
  - [Any modifications to existing behavior]

  ### Fixed
  - [Bug fixes included in this feature]
  ```

  **Result (2026-01-23):** Updated `Observability/CHANGELOG.md` with F-2 entry including: `logEvent()`, `isObservabilityEnabled()`, `getTodayLogPath()`, date-partitioned output, settings.json toggle, sync I/O, error suppression, auto-directory creation. Test coverage updated to 131 tests, 415 assertions.

### 7. Sanitization Checklist

Before creating PR, verify no sensitive data is included.

- [x] **Check for secrets**:
  ```bash
  grep -rE "(API_KEY|TOKEN|SECRET|PASSWORD)" --include="*.ts" --include="*.md"
  ```

  **Result (2026-01-23):** 3 files matched but all safe:
  - `TOKEN_ESTIMATES` variable name in metrics composable
  - `ANTHROPIC_API_KEY` being read from `.env` (not hardcoded)

- [x] **Check for personal paths**:
  ```bash
  grep -r "/Users/" --include="*.ts" --include="*.md"
  ```

  **Result (2026-01-23):** 3 matches, all safe:
  - Generic example `"/Users/you/.claude/..."` in docstring
  - Test fixture `"/Users/test/project"` (fake test data)

- [x] **Check for hardcoded usernames**:
  ```bash
  grep -rE "(your-username|your-email)" --include="*.ts" --include="*.md"
  ```

  **Result (2026-01-23):** No matches found. ✅

- [x] **Verify config externalized**:
  - [x] Secrets in `.env` files (not committed)
  - [x] No hardcoded credentials in source

  **Result (2026-01-23):** Only `.env.example` and `.env.template` files in git. Actual `.env` files are gitignored. ✅

### 8. Create File Inventory

- [x] **List files for PR** in `.maestro/outputs/FILE_INVENTORY.md`:

  ```markdown
  ## File Inventory

  ### Include (✅)
  | File | Reason |
  |------|--------|
  | `src/feature.ts` | Core implementation |
  | `test/feature.test.ts` | Test coverage |
  | `docs/feature.md` | Documentation |

  ### Exclude (❌)
  | Path | Reason |
  |------|--------|
  | `.env` | Contains secrets |
  | `test/fixtures/` | May contain PII |
  ```

  **Result (2026-01-23):** Created `.maestro/outputs/FILE_INVENTORY.md` with 9 files to include (3 core implementation: log.ts, log.test.ts, index.ts; 6 documentation: spec/plan/tasks/docs/verify.md, CHANGELOG) and 5 patterns to exclude (secrets, databases, temp files).

### 9. Prepare for Next Feature

- [x] **Check if more features pending**:
  ```bash
  specflow next
  ```

  If more features:
  - Document completion in `.maestro/outputs/COMPLETION.md`
  - Optionally continue with next feature

  **Result (2026-01-23):** 13 features remaining (F-3 through F-15). Next by priority: F-15 Docker Compose Stack (P1). Created `.maestro/outputs/COMPLETION.md` with F-2 summary.

## Output

- Feature marked complete in database
- `CHANGELOG.md` updated with feature entry
- `.maestro/outputs/FILE_INVENTORY.md` with PR file list
- `.maestro/outputs/COMPLETION.md` summary

## Human Gate

**STOP** - Present completion to human for final review.

Show:
1. `specflow status` output
2. Test results summary
3. CHANGELOG.md entry
4. FILE_INVENTORY.md (files for PR)
5. Sanitization check results

## Post-Completion

When ready to release:
```bash
# Stage changes
git add <specific files>

# Create commit
git commit -m "feat: [feature description]

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

# Push and create PR
git push -u origin <branch>
gh pr create --title "[title]" --body "..."
```

## Optional: Self-Review with PR_Review Playbook

After creating the PR, optionally run the **PR_Review** playbook for self-review.

## Feature Loop: Initialize Next Feature

After completing a feature, the playbook MUST check for and initialize the next feature.

### 10. Clear Current Feature State

- [x] **Archive completed feature context**:

  Move current feature file to completed archive:
  ```bash
  mkdir -p .maestro/outputs/COMPLETED_FEATURES
  mv .maestro/CURRENT_FEATURE.md .maestro/outputs/COMPLETED_FEATURES/FEATURE_<id>_$(date +%Y-%m-%d).md
  ```

  **Result (2026-01-23):** Archived F-2 feature file to `.maestro/outputs/COMPLETED_FEATURES/FEATURE_F-2_2026-01-23.md`. ✅

### 11. Check for Next Feature

- [x] **List remaining pending features (by ID order)**:
  ```bash
  # Get next pending feature by ID order (not priority)
  NEXT_FEATURE=$(specflow status --json | jq -r '.features[] | select(.status == "pending") | .id' | sort -t'-' -k2 -n | head -1)
  echo "Next feature: $NEXT_FEATURE"
  ```

  **If features remain** (NEXT_FEATURE is not empty):
  - Record the feature ID (e.g., F-2, F-3, etc.)
  - Proceed to Task 12

  **If NO features remain** (NEXT_FEATURE is empty):
  - Write to `.maestro/CURRENT_FEATURE.md`:
    ```markdown
    # Current Feature
    ALL_FEATURES_COMPLETE

    All features have been implemented. Playbook complete.
    Date: <date>
    ```
  - Exit playbook (do NOT loop)

  **Result (2026-01-23):** Next feature is **F-3 - Concurrent Write Handling**. 13 features remain pending (F-3, F-4, F-5, F-6, F-7, F-8, F-9, F-10, F-11, F-12, F-13, F-14, F-15). Proceeding to Task 12. ✅

### 12. Initialize Next Feature

- [x] **Create new CURRENT_FEATURE.md for next feature**:

  Write to `.maestro/CURRENT_FEATURE.md`:
  ```markdown
  # Current Feature

  - **Feature ID:** <next-feature-id>
  - **Feature Name:** <feature-name>
  - **Started:** <date>
  - **Phase:** none

  ## Notes

  Auto-selected as next feature in ID sequence after completing previous feature.
  ```

  **Result (2026-01-23):** Created `.maestro/CURRENT_FEATURE.md` with F-3 (Concurrent Write Handling) details. ✅

- [x] **Check if feature needs spec initialization**:
  ```bash
  specflow status <next-feature-id>
  ```

  If phase is `none`, run:
  ```bash
  specflow specify <next-feature-id>
  ```

  **Result (2026-01-23):** F-3 is at phase "none". Ran `specflow specify F-3` but the command requires interactive input (specification interview). F-3 is ready for specification in next session. ✅

### 13. Reset Playbook for Next Feature

- [x] **Clear loop artifacts from previous feature**:

  Remove old loop files (keep COMPLETED_FEATURES archive):
  ```bash
  rm -f .maestro/outputs/LOOP_*_PROGRESS.md
  rm -f .maestro/outputs/LOOP_*_TEST_RESULTS.md
  rm -f .maestro/outputs/FILE_INVENTORY.md
  rm -f .maestro/outputs/COMPLETION.md
  ```

  **Result (2026-01-23):** Removed 4 files: LOOP_PROGRESS.md, LOOP_TEST_RESULTS.md, FILE_INVENTORY.md, COMPLETION.md. COMPLETED_FEATURES directory preserved. ✅

- [x] **Log feature transition**:

  Append to `.maestro/outputs/PLAYBOOK_LOG.md`:
  ```markdown
  ## Feature Transition - <date>

  - **Completed:** <previous-feature-id> - <previous-feature-name>
  - **Starting:** <next-feature-id> - <next-feature-name>
  - **Transition Time:** [timestamp]
  ```

  **Result (2026-01-23):** Created `.maestro/outputs/PLAYBOOK_LOG.md` with F-2→F-3 transition details, including F-2 summary (131 tests, key functions) and F-3 next steps. ✅

## Loop Control

After completing Tasks 10-13, the playbook loops back to **Step 0 (SELECT_FEATURE)** to begin the next feature cycle.

**Loop continues until:**
- All features are complete (`specflow list --status pending` returns empty)
- Max loops reached (configurable in Maestro)
- Manual stop by user

---

## Playbook Complete (Final Exit)

The playbook only exits when `.maestro/CURRENT_FEATURE.md` contains `ALL_FEATURES_COMPLETE`.

At that point:
1. All features have been implemented
2. PR_Review playbook can be run for final review
3. Session ends
