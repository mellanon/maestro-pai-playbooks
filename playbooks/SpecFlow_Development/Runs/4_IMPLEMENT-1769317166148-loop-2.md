# Step 4: IMPLEMENT - TDD Execution

**Phase**: Implementation | **Loop**: Repeats until all tasks complete

---

## Context
- **Playbook:** SpecFlow Development
- **State Directory:** `.maestro/` (in project root)

## Objective

Implement the next task using TDD (Test-Driven Development).

## Prerequisites

- Tasks approved (tasks.md exists and human approved)
- Feature phase is "tasks" or "implement"
- **State directory exists** (create if needed):
  ```bash
  mkdir -p .maestro/outputs
  ```

## Phase Guard (MUST RUN FIRST)

Before doing any work, verify this step should run:

- [x] **Check if this step should execute**: SKIPPED - ALL_FEATURES_COMPLETE (Phase guard check: .maestro/CURRENT_FEATURE.md indicates all 18 features are complete with 708 passing tests)
  ```bash
  # Read current feature ID
  FEATURE_ID=$(grep "Feature ID:" .maestro/CURRENT_FEATURE.md 2>/dev/null | awk -F: '{print $2}' | tr -d ' ')

  # Check if ALL_FEATURES_COMPLETE
  if grep -q "ALL_FEATURES_COMPLETE" .maestro/CURRENT_FEATURE.md 2>/dev/null; then
    echo "PHASE_GUARD: SKIP - All features complete"
    # Exit document as NO-OP
    exit 0
  fi

  # Check feature has incomplete tasks
  if [[ -z "$FEATURE_ID" ]]; then
    echo "PHASE_GUARD: SKIP - No current feature"
    exit 0
  fi

  # Query SpecFlow for task status
  INCOMPLETE_COUNT=$(specflow status "$FEATURE_ID" --json 2>/dev/null | jq -r '[.tasks[] | select(.status != "complete")] | length' 2>/dev/null || echo "0")

  if [[ "$INCOMPLETE_COUNT" -eq 0 ]]; then
    echo "PHASE_GUARD: SKIP - All tasks complete, proceed to Step 5/6"
    exit 0
  fi

  echo "PHASE_GUARD: PROCEED - $INCOMPLETE_COUNT incomplete tasks for $FEATURE_ID"
  ```

**If phase guard returns SKIP:** Mark ALL remaining tasks below as `[x] SKIPPED - Phase guard` and proceed to next document. This prevents stall detection from flagging unchecked boxes.

## Instructions

### 1. Get Implementation Context

- [x] **Get next task context**: SKIPPED - Phase guard
  ```bash
  specflow implement
  ```

  Or for a specific feature:
  ```bash
  specflow implement --feature <feature-id>
  ```

  This outputs:
  - Feature spec
  - Technical plan
  - Tasks with current progress
  - Implementation prompt for AI

### 2. TDD Cycle: RED

- [x] **Write failing test first**: SKIPPED - Phase guard
  - Create test file if doesn't exist
  - Write test for the current task's acceptance criteria
  - Run tests to confirm failure (RED state)

- [x] **Record test creation** in `.maestro/outputs/LOOP_PROGRESS.md`: SKIPPED - Phase guard
  ```markdown
  ## Task: [task name]
  ### Tests Written
  * test_xxx: [description]
  ```

### 3. TDD Cycle: GREEN

- [x] **Implement minimal code** to make tests pass: SKIPPED - Phase guard
  - Focus only on current task
  - Don't over-engineer
  - Follow the plan.md architecture

- [x] **Run tests** to confirm passing (GREEN state): SKIPPED - Phase guard
  ```bash
  bun test
  # or project-specific test command
  ```

### 4. TDD Cycle: REFACTOR (if needed)

- [x] **Clean up code** while keeping tests green: SKIPPED - Phase guard
  - Remove duplication
  - Improve naming
  - Keep it simple

### 5. Update Progress

- [x] **Update progress file**: SKIPPED - Phase guard
  ```markdown
  ### Implementation
  - Files created: [list]
  - Files modified: [list]
  - Tests passing: [count]
  ```

## Output

- New/modified source files
- New/modified test files
- `.maestro/outputs/LOOP_PROGRESS.md` updated

---

## ⚠️ SKIP VALIDATION GATE (SMS-452)

**DO NOT skip features without using the validated skip command.**

If you believe a feature is a duplicate or should be skipped:

1. **STOP** - Do not silently mark as skipped
2. **Use validated skip**:
   ```bash
   specflow skip <feature-id> \
     --reason <duplicate|deferred|blocked|out_of_scope|superseded> \
     --justification "Detailed explanation" \
     --duplicate-of <id>  # Required if reason=duplicate
   ```

3. **Duplicate validation**:
   - Target feature must exist and be complete/in_progress
   - Skip will FAIL if validation fails
   - This prevents incorrect "duplicate" judgments

**Background:** F-12 was incorrectly skipped as "duplicate of F-11" but they were
distinct features (service vs config). See RCA SMS-452.

---

## Next

→ Proceed to Step 5 (VERIFY) to check progress and loop control
