# Step 4: IMPLEMENT - TDD Execution

**Phase**: Implementation | **Loop**: Repeats until all tasks complete

---

## Context
- **Playbook:** SpecFlow Development
- **State Directory:** `.maestro/` (in project root)

## Objective

Implement the next task using TDD (Test-Driven Development).

## Prerequisites

- Tasks approved (tasks.md exists and human approved)
- Feature phase is "tasks" or "implement"
- **State directory exists** (create if needed):
  ```bash
  mkdir -p .maestro/outputs
  ```

## Instructions

### 1. Get Implementation Context

- [x] **Get next task context**:
  ```bash
  specflow implement
  ```

  Or for a specific feature:
  ```bash
  specflow implement --feature <feature-id>
  ```

  This outputs:
  - Feature spec
  - Technical plan
  - Tasks with current progress
  - Implementation prompt for AI

### 2. TDD Cycle: RED

- [x] **Write failing test first**:
  - Created hooks/__tests__/PostToolUseInstrumentation.test.ts (29 tests)
  - Tests written for parseInput, emitToolResultEvent, processHookInput
  - Integration tests for no stdout, exit 0, debug output

- [x] **Record test creation** in `.maestro/outputs/LOOP_PROGRESS.md`:
  ```markdown
  ## Task: [task name]
  ### Tests Written
  * test_xxx: [description]
  ```

### 3. TDD Cycle: GREEN

- [x] **Implement minimal code** to make tests pass:
  - Extended ToolResultData interface with status, result, error fields
  - Created hooks/PostToolUseInstrumentation.hook.ts (~140 lines)
  - Added hook to settings.json PostToolUse array (first position)

- [x] **Run tests** to confirm passing (GREEN state):
  ```bash
  bun test
  # or project-specific test command
  ```

### 4. TDD Cycle: REFACTOR (if needed)

- [x] **Clean up code** while keeping tests green:
  - No refactoring needed - code follows PreToolUse pattern exactly
  - All 339 tests still passing

### 5. Update Progress

- [x] **Update progress file**:

  ### Implementation Complete
  - Files created:
    - hooks/PostToolUseInstrumentation.hook.ts
    - hooks/__tests__/PostToolUseInstrumentation.test.ts
    - .specify/specs/f-8-posttooluse-hook-instrumentation/docs.md
    - .specify/specs/f-8-posttooluse-hook-instrumentation/verify.md
  - Files modified:
    - Observability/lib/events/types.ts (extended ToolResultData)
    - settings.json (added PostToolUse hook)
    - .specify/specs/f-8-posttooluse-hook-instrumentation/tasks.md (progress tracking)
  - Tests passing: 339 (29 new for PostToolUseInstrumentation)

## Output

- New/modified source files
- New/modified test files
- `.maestro/outputs/LOOP_PROGRESS.md` updated

## Next

â†’ Proceed to Step 5 (VERIFY) to check progress and loop control
