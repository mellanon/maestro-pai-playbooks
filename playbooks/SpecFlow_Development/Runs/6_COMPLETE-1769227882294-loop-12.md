# Step 6: COMPLETE - Validation and Finalization

**Phase**: Completion | **Gate**: Automated

---

## Context
- **Playbook:** SpecFlow Development
- **State Directory:** `.maestro/` (in project root)

## Objective

Validate all phases complete and mark the feature as done.

## Prerequisites

- All tests passing
- All tasks complete
- Step 5 loop control indicates completion

## Instructions

### 1. Final Validation

- [x] **Run comprehensive validation**:
  ```bash
  specflow validate F-016
  ```

  This checks:
  - ✓ spec.md exists and valid
  - ✓ plan.md exists and valid
  - ✓ tasks.md exists and all tasks complete
  - ✓ Tests referenced in tasks pass

  **Note (Loop 12):** Validation passed after creating docs.md and verify.md (required by SpecFlow workflow).

### 2. Run Final Tests

- [x] **Execute full test suite**:
  ```bash
  bun test
  ```

  **Result:** 460 tests passed, 1402 expect() calls across 15 test files.

- [x] **Run type checking** (if applicable):
  ```bash
  bunx tsc --noEmit
  ```

  **Note:** No tsconfig.json in project - type checking via Bun runtime.

### 3. Mark Feature Complete

- [x] **Complete the feature**:
  ```bash
  specflow complete F-016 --force
  ```

  This:
  - Validates all SpecFlow phases
  - Runs the Doctorow Gate checklist
  - Updates feature status to "complete"

  **Result:** F-016 marked as complete. Progress: 16/16 features (100%)

### 4. Review Doctorow Gate

The `specflow complete` command includes the **Doctorow Gate** - a checklist ensuring quality:

| Check | Status |
|-------|--------|
| Tests exist and pass | ✓ 35 tests, 98 expect() calls |
| No unnecessary complexity added | ✓ Minimal hook design |
| Code follows existing patterns | ✓ Uses paiPath, fail-open |
| Documentation updated if needed | ✓ docs.md + verify.md created |

### 5. Verify Completion

- [x] **Check final status**:
  ```bash
  specflow status
  ```

  **Result:** F-016 shows `● complete`. All 16 features now complete (100%).

### 6. Update Changelog

- [x] **Generate changelog entry from spec**:

  Read the feature's `spec.md` and extract:
  - Feature name and description
  - Key capabilities added
  - Breaking changes (if any)

  **Result (Loop 12):** Extracted F-016 "Skill Invocation Enforcement" details from `.specify/specs/f-016-skill-invocation-enforcement/spec.md`.

- [x] **Update CHANGELOG.md**:
  ```markdown
  ## [Unreleased]

  ### Added
  - [Feature]: [Description from spec.md]

  ### Changed
  - [Any modifications to existing behavior]

  ### Fixed
  - [Bug fixes included in this feature]
  ```

  **Result (Loop 12):** Added F-016 entry to CHANGELOG.md with description of PreToolUse hook for skill customization enforcement, EXTEND.yaml support, and fail-open error handling.

### 7. Sanitization Checklist

Before creating PR, verify no sensitive data is included.

- [x] **Check for secrets**:
  ```bash
  grep -rE "(API_KEY|TOKEN|SECRET|PASSWORD)" --include="*.ts" --include="*.md"
  ```

  **Result (Loop 12):** Found references to API keys in documentation and code that reads from environment variables. No hardcoded secrets detected. All sensitive values are properly externalized to `.env` files.

- [x] **Check for personal paths**:
  ```bash
  grep -r "/Users/" --include="*.ts" --include="*.md"
  ```

  **Result (Loop 12):** F-016 implementation files (`SkillInvocationEnforcement.hook.ts`, `SkillInvocationEnforcement.hook.test.ts`) contain no hardcoded personal paths. Pre-existing hardcoded paths found in `bin/ingest/lib/process.ts` (whisper.cpp paths) and various documentation/spec files - these are outside F-016 scope.

- [x] **Check for hardcoded usernames**:
  ```bash
  grep -rE "(your-username|your-email)" --include="*.ts" --include="*.md"
  ```

  **Result (Loop 12):** Found only placeholder examples in documentation (e.g., `JIRA_USERNAME=your-email@example.com`). These are intentional documentation examples, not actual hardcoded credentials.

- [x] **Verify config externalized**:
  - [x] Secrets in `.env` files (not committed) - `.gitignore` properly excludes `.env`, `.env.*`, `*.env`, `secrets/`, `credentials/`, `*.pem`, `*.key`
  - [x] No hardcoded credentials in source - F-016 implementation contains no hardcoded credentials

### 8. Create File Inventory

- [x] **List files for PR** in `.maestro/outputs/FILE_INVENTORY.md`:

  **Result (Loop 12):** Created FILE_INVENTORY.md with:
  - **Include:** 8 F-016 files (hook implementation, tests, spec files, CHANGELOG)
  - **Exclude:** `.env`, `.maestro/`, `.specflow/*.db*`, `settings.json`
  - Also documented other branch changes (F-001 through F-015) for context

### 9. Prepare for Next Feature

- [x] **Check if more features pending**:
  ```bash
  specflow next
  ```

  **Result (Loop 12):** `specflow next` reports "All features complete or no pending features."
  - `specflow status` confirms 16/16 features complete (100%)
  - Created `.maestro/outputs/COMPLETION.md` with full completion report
  - No more features to process - playbook complete

## Output

- Feature marked complete in database
- `CHANGELOG.md` updated with feature entry
- `.maestro/outputs/FILE_INVENTORY.md` with PR file list
- `.maestro/outputs/COMPLETION.md` summary

## Post-Completion

When ready to release:
```bash
# Stage changes
git add <specific files>

# Create commit
git commit -m "feat: [feature description]

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

# Push and create PR
git push -u origin <branch>
gh pr create --title "[title]" --body "..."
```

## Optional: Self-Review with PR_Review Playbook

After creating the PR, optionally run the **PR_Review** playbook for self-review.

## Feature Loop: Initialize Next Feature

After completing a feature, the playbook MUST check for and initialize the next feature.

### 10. Clear Current Feature State

- [x] **Archive completed feature context**:

  Move current feature file to completed archive:
  ```bash
  mkdir -p .maestro/outputs/COMPLETED_FEATURES
  mv .maestro/CURRENT_FEATURE.md .maestro/outputs/COMPLETED_FEATURES/FEATURE_<id>_$(date +%Y-%m-%d).md
  ```

  **Result (Loop 12):** Archived F-016 to `.maestro/outputs/COMPLETED_FEATURES/FEATURE_F-016_2026-01-24.md`

### 11. Check for Next Feature

- [x] **List remaining pending features (by ID order)**:
  ```bash
  # Get next pending feature by ID order (not priority)
  NEXT_FEATURE=$(specflow status --json | jq -r '.features[] | select(.status == "pending") | .id' | sort -t'-' -k2 -n | head -1)
  echo "Next feature: $NEXT_FEATURE"
  ```

  **If features remain** (NEXT_FEATURE is not empty):
  - Record the feature ID (e.g., F-2, F-3, etc.)
  - Proceed to Task 12

  **If NO features remain** (NEXT_FEATURE is empty):
  - Write to `.maestro/CURRENT_FEATURE.md`:
    ```markdown
    # Current Feature
    ALL_FEATURES_COMPLETE

    All features have been implemented. Playbook complete.
    Date: <date>
    ```
  - Exit playbook (do NOT loop)

  **Result (Loop 12):** NEXT_FEATURE is empty - all 16 features complete. Wrote `ALL_FEATURES_COMPLETE` to `.maestro/CURRENT_FEATURE.md`. Playbook exits.

### 12. Initialize Next Feature

- [x] **Create new CURRENT_FEATURE.md for next feature**:

  **SKIPPED (Loop 12):** No next feature exists - ALL_FEATURES_COMPLETE was set in Task 11. This task only applies when features remain pending.

- [x] **Check if feature needs spec initialization**:

  **SKIPPED (Loop 12):** No next feature to check - playbook complete.

### 13. Reset Playbook for Next Feature

- [x] **Clear loop artifacts from previous feature**:

  **SKIPPED (Loop 12):** Artifacts preserved for PR review since this is the final feature. No cleanup needed - these artifacts document the completed work.

- [x] **Log feature transition**:

  **SKIPPED (Loop 12):** No feature transition to log - ALL_FEATURES_COMPLETE. Final playbook status documented in `.maestro/outputs/COMPLETION.md`.

## Loop Control

After completing Tasks 10-13, the playbook loops back to **Step 0 (SELECT_FEATURE)** to begin the next feature cycle.

**Loop continues until:**
- All features are complete (`specflow list --status pending` returns empty)
- Max loops reached (configurable in Maestro)
- Manual stop by user

---

## Playbook Complete (Final Exit)

The playbook only exits when `.maestro/CURRENT_FEATURE.md` contains `ALL_FEATURES_COMPLETE`.

At that point:
1. All features have been implemented
2. PR_Review playbook can be run for final review
3. Session ends
