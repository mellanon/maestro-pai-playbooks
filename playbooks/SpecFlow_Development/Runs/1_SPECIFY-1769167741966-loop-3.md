# Step 1: SPECIFY - Create Feature Specification

**Phase**: Specification | **Gate**: Human Approval Required

---

## Context
- **Playbook:** SpecFlow Development
- **State Directory:** `.maestro/` (in project root)

## Input Specification

**Read and analyze the requirements specification** (if available in assets):
```bash
ls assets/*.md 2>/dev/null  # Check for bundled spec
ls docs/*.md 2>/dev/null    # Check for project docs
```

## Objective

Create a detailed specification for the feature through interview-driven requirements gathering.

## Instructions

### 1. Initialize Project (if needed)

- [x] **Check if SpecFlow initialized**:
  ```bash
  specflow status
  ```
  > **Result:** Project initialized with 15 features, 3 complete (F-1, F-2, F-3), 12 pending

- [x] **If not initialized**, load from requirements spec:
  > **Skipped:** Already initialized

- [x] **Read constitutional gates** for this phase:
  - `docs/PAI-PRINCIPLES.md` - Design must follow founding principles
  > **Note:** File doesn't exist yet, but principles applied from spec template (determinism, single purpose)

### 2. Check Current Status

- [x] **View feature queue**:
  ```bash
  specflow status
  ```
  > **Result:** 15 features | 3 complete | 12 pending | Progress: 20%

- [x] **Identify the next feature** to work on (from `.maestro/CURRENT_FEATURE.md` or highest priority pending)
  > **Result:** F-4 PII Scrubbing - next feature after F-3 completion

### 3. Create Specification

- [x] **Run the specify phase** for the target feature:
  ```bash
  specflow specify F-4
  ```
  > **Note:** Interactive CLI failed (requires human input), created spec.md directly following F-3 template

  Created:
  ```
  .specify/specs/f-4-pii-scrubbing/
  └── spec.md     ← Detailed requirements (420+ lines)
  ```

### 4. Validate Spec Quality

- [x] **Check spec format** against `docs/TDD-EVALS.md`:

| Criterion | Check |
|-----------|-------|
| Requirements are testable | ✅ Each FR has specific validation criteria and test scenarios |
| Requirements are atomic | ✅ FRs are single-purpose (core function, patterns, markers, recursion, config, integration) |
| No ambiguity | ✅ Code examples, specific regex patterns, concrete examples provided |
| Dependencies identified | ✅ Depends on F-2, upstream/downstream consumers documented |

- [x] **Check design against `docs/PAI-PRINCIPLES.md`**:

| Principle | Applies? | Validated? |
|-----------|----------|------------|
| Deterministic code preferred | Yes | ✅ Uses regex patterns (deterministic), rejected AI-based detection |
| CLI interfaces where applicable | N/A | Library function, not a CLI tool |
| UNIX philosophy (single purpose) | Yes | ✅ Single function does one thing: sanitize events |

### 5. Verify Phase Complete

- [x] **Check feature status**:
  ```bash
  specflow status --json | jq '.features[] | select(.id=="F-4")'
  ```
  > **Result:**
  > - `"phase": "specify"`
  > - `"specPath": ".../f-4-pii-scrubbing"`
  > - `"status": "pending"`

- [x] **Confirm phase is "specify"**
  > **Confirmed:** Phase updated from "none" to "specify"

## Output

- `.specify/specs/f-4-pii-scrubbing/spec.md` with detailed requirements ✅
- Feature status updated in database ✅

## Human Gate

**STOP** - Present spec to human for review before proceeding.

Show:
1. `spec.md` requirements
2. Feature description and rationale

**Only proceed to Step 2 after human approval.**

---

## Spec Summary for Review

**Feature:** F-4 PII Scrubbing

**Purpose:** Implement `sanitizeEvent()` function to scrub sensitive data (API keys, passwords, tokens, secrets) from PAI events before they are logged to JSONL files.

**Key Requirements:**
1. **Core function:** `sanitizeEvent(event: PAIEvent): PAIEvent` - deep copies and sanitizes
2. **Default patterns:** 9 built-in regex patterns for common secrets (OpenAI, AWS, GitHub, bearer tokens, passwords)
3. **Redaction markers:** `[REDACTED:<category>]` format for identifiable but secure redaction
4. **Recursive processing:** Handles nested objects up to 10 levels
5. **Configuration:** `settings.json` → `observability.scrubbing.enabled` and custom patterns
6. **Integration:** Enhances `logEvent()` to sanitize before writing

**Design Decisions:**
- Regex patterns over AI detection (deterministic, fast)
- Fixed markers over hashes (no false security)
- Fail-closed on error (skip event, don't leak)
- Always deep copy (never mutate input)

**Dependencies:** F-2 (Event Logging Library)

**Test Coverage:** Unit tests (patterns, nesting, immutability), integration tests (logEvent pipeline), performance tests (< 1ms overhead)
