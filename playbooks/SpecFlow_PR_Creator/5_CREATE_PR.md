# Document 5: Prepare Pull Request

## Context

- **Playbook**: SpecFlow PR Creator
- **Agent**: {{AGENT_NAME}}
- **Project**: {{AGENT_PATH}}
- **Date**: {{DATE}}
- **Working Folder**: {{AUTORUN_FOLDER}}

## Purpose

Generate a comprehensive PR description document from all gathered artifacts. **The actual PR creation is human-triggered** - this document prepares everything needed but stops short of executing `gh pr create`.

## Human Oversight Model

```
┌─────────────────────────────────────────────────────────────────┐
│  AGENT AUTOMATED                 │  HUMAN TRIGGERED             │
├──────────────────────────────────┼──────────────────────────────┤
│  ✓ Generate PR_DESCRIPTION.md   │  → Review PR_DESCRIPTION.md  │
│  ✓ Generate PR_COMMAND.sh       │  → Execute PR_COMMAND.sh     │
│  ✓ Push branch to remote        │  → Approve PR creation       │
│  ✓ Prepare all artifacts        │  → Add reviewers             │
└──────────────────────────────────┴──────────────────────────────┘
```

## Prerequisites

- `{{AUTORUN_FOLDER}}/SPECFLOW_CONTEXT.md` exists
- `{{AUTORUN_FOLDER}}/CHANGELOG.md` exists
- `{{AUTORUN_FOLDER}}/BRANCH_COMPARISON.md` exists
- `{{AUTORUN_FOLDER}}/INSTALLATION_GUIDE.md` exists

## Tasks

### Task 1: Prepare Final Commit (if needed)

- [ ] **Check for uncommitted changes**:
  ```bash
  git status --porcelain
  ```

- [ ] **If changes exist, create final commit**:
  ```bash
  git add -A
  git commit -m "feat: Complete SpecFlow features F-1 through F-N

  Implements:
  - F-1: [name]
  - F-2: [name]

  Generated by {{AGENT_NAME}} via SpecFlow PR Creator playbook"
  ```

- [ ] **Push branch to remote**:
  ```bash
  git push -u origin $(git branch --show-current)
  ```

### Task 2: Generate PR Description

- [ ] **Write PR_DESCRIPTION.md**: Create `{{AUTORUN_FOLDER}}/PR_DESCRIPTION.md`:

```markdown
## Summary

This PR implements [N] features from the SpecFlow queue:

| Feature | Description | Tests | Quality |
|---------|-------------|-------|---------|
| F-1 | [name] | [count] | [score]% |
| F-2 | [name] | [count] | [score]% |

**Agent:** {{AGENT_NAME}}
**Branch:** [branch-name]
**Target:** $TARGET_BRANCH

## Features Implemented

### F-1: [Feature Name]

[Brief description from spec.md]

**Acceptance Criteria:**
- [x] [Criterion 1]
- [x] [Criterion 2]
- [x] [Criterion 3]

**Key Changes:**
- [Change 1 from docs.md]
- [Change 2]

### F-2: [Feature Name]

[Same structure...]

## Changes Overview

| Category | Count | Details |
|----------|-------|---------|
| Source files | [N] | New modules, utilities |
| Test files | [N] | [X] tests total |
| Configuration | [N] | [details] |
| Documentation | [N] | Spec artifacts |

**Lines changed:** +[added]/-[removed]

## Quality Gates

All SpecFlow quality gates passed:

| Gate | Status |
|------|--------|
| Spec quality | ✓ [avg]% |
| Plan quality | ✓ [avg]% |
| Tests passing | ✓ 100% |
| Doctorow Gate | ✓ All checks |

## Testing

### Automated Tests
- [x] All existing tests pass
- [x] New tests added: [count]
- [x] Coverage maintained/improved

### Manual Verification
```bash
# Verify new modules
bun -e "import * as mod from './[path]'; console.log(Object.keys(mod))"

# Run tests
bun test
```

## Installation

See `INSTALLATION_GUIDE.md` in the PR artifacts for detailed instructions.

**Quick upgrade:**
```bash
git fetch origin [branch]
git merge origin/[branch]
bun install
bun run install.ts --migrate
```

## Breaking Changes

[None / List from BRANCH_COMPARISON.md]

## Checklist

- [x] All SpecFlow features complete
- [x] Tests pass locally
- [x] Changelog generated
- [x] Installation guide created
- [x] No hardcoded secrets
- [x] Documentation updated

## Related

- SpecFlow artifacts: `.specify/specs/`
- Playbook artifacts: `[AUTORUN_FOLDER]`

---

*PR prepared by {{AGENT_NAME}} via SpecFlow PR Creator Playbook*
```

### Task 3: Generate PR Command Script

- [ ] **Write PR_COMMAND.sh**: Create `{{AUTORUN_FOLDER}}/PR_COMMAND.sh`:

```bash
#!/bin/bash
# ═══════════════════════════════════════════════════════════════
# PR Creation Script - HUMAN REVIEW REQUIRED
# ═══════════════════════════════════════════════════════════════
#
# Agent: {{AGENT_NAME}}
# Branch: [branch-name]
# Target: $TARGET_BRANCH
# Generated: {{DATE}}
#
# BEFORE RUNNING:
# 1. Review PR_DESCRIPTION.md
# 2. Review CHANGELOG.md
# 3. Verify branch is correct: git branch --show-current
# 4. Verify target is correct: $TARGET_BRANCH
#
# ═══════════════════════════════════════════════════════════════

set -e

AUTORUN_FOLDER="{{AUTORUN_FOLDER}}"
BRANCH_NAME="$(git branch --show-current)"
TARGET_BRANCH="$TARGET_BRANCH"
PR_TITLE="feat: [F-1 through F-N] - [brief summary]"

echo "Creating PR: $BRANCH_NAME → $TARGET_BRANCH"
echo "Title: $PR_TITLE"
echo ""
read -p "Proceed? (y/N) " -n 1 -r
echo ""

if [[ $REPLY =~ ^[Yy]$ ]]; then
    PR_URL=$(gh pr create \
        --base "$TARGET_BRANCH" \
        --title "$PR_TITLE" \
        --body-file "$AUTORUN_FOLDER/PR_DESCRIPTION.md" \
        --label "specflow,automated")

    echo ""
    echo "✓ PR Created: $PR_URL"
    echo ""

    # Extract PR number
    PR_NUMBER=$(echo "$PR_URL" | grep -o '[0-9]*$')

    # Save PR info for manifest
    echo "{\"prNumber\": $PR_NUMBER, \"prUrl\": \"$PR_URL\"}" > "$AUTORUN_FOLDER/PR_INFO.json"

    echo "PR info saved to: $AUTORUN_FOLDER/PR_INFO.json"
    echo ""
    echo "Next steps:"
    echo "  1. Run Document 6 (Finalize) to generate PR_MANIFEST.json"
    echo "  2. Add reviewers: gh pr edit $PR_NUMBER --add-reviewer [username]"
else
    echo "Aborted."
    exit 1
fi
```

- [ ] **Make script executable**:
  ```bash
  chmod +x "{{AUTORUN_FOLDER}}/PR_COMMAND.sh"
  ```

### Task 4: Create Human Instructions

- [ ] **Write NEXT_STEPS.md**: Create `{{AUTORUN_FOLDER}}/NEXT_STEPS.md`:

```markdown
# Next Steps - Human Action Required

## PR Ready for Creation

The agent has prepared all PR artifacts. Human review is required before creating the PR.

## Files to Review

1. **PR_DESCRIPTION.md** - The PR body content
2. **CHANGELOG.md** - Detailed changelog
3. **BRANCH_COMPARISON.md** - What this branch adds
4. **INSTALLATION_GUIDE.md** - How to install/upgrade

## Create the PR

After review, run:

```bash
./{{AUTORUN_FOLDER}}/PR_COMMAND.sh
```

Or manually:

```bash
gh pr create \
  --base $TARGET_BRANCH \
  --title "feat: [your title]" \
  --body-file "{{AUTORUN_FOLDER}}/PR_DESCRIPTION.md"
```

## After PR Creation

1. Run Document 6 (Finalize) to generate `PR_MANIFEST.json`
2. Or manually create the manifest with:
   ```bash
   gh pr view --json number,url,title,additions,deletions
   ```

## Verification Checklist

Before creating PR:
- [ ] Reviewed PR_DESCRIPTION.md
- [ ] Branch name is correct
- [ ] Target branch ($TARGET_BRANCH) is correct
- [ ] All tests pass locally
- [ ] No secrets in committed files
```

### Task 5: Verify Artifacts Ready

- [ ] **Confirm all PR artifacts exist**:
  - [ ] `PR_DESCRIPTION.md` - PR body content
  - [ ] `PR_COMMAND.sh` - Executable script
  - [ ] `NEXT_STEPS.md` - Human instructions
  - [ ] Branch pushed to remote

- [ ] **Output status**:

```
═══════════════════════════════════════════════════════════════
PR PREPARATION COMPLETE - HUMAN ACTION REQUIRED
═══════════════════════════════════════════════════════════════
Agent:        {{AGENT_NAME}}
Branch:       [branch-name] (pushed)
Target:       $TARGET_BRANCH

Artifacts:
  PR_DESCRIPTION.md  ✓
  PR_COMMAND.sh      ✓
  NEXT_STEPS.md      ✓

To create PR:
  ./{{AUTORUN_FOLDER}}/PR_COMMAND.sh

Or review first:
  cat {{AUTORUN_FOLDER}}/PR_DESCRIPTION.md
═══════════════════════════════════════════════════════════════
```

## Success Criteria

- PR_DESCRIPTION.md generated with all feature details
- PR_COMMAND.sh ready for human execution
- NEXT_STEPS.md explains what to do
- Branch is pushed to remote
- **PR NOT YET CREATED** - awaiting human trigger

## Status

Mark complete when all artifacts are ready for human review.
